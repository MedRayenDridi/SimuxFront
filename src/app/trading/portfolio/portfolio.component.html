<div class="dashboard">
  <app-sidebar></app-sidebar>

  <main class="content">
    <header class="topbar">
      <div class="search">
        <input placeholder="Search stocks, crypto..." [(ngModel)]="searchTerm">
      </div>
      <div class="actions">
        <button class="icon" title="Refresh" (click)="refreshData()">âŸ³</button>
        <button class="icon" title="Notifications">ðŸ””</button>
        <div class="date-range">{{ today | date:'d MMM yyyy' }}</div>
        <div class="avatar">ðŸ‘¤</div>
      </div>
    </header>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-overlay">
      <div class="spinner">Loading portfolio...</div>
    </div>

    <!-- Portfolio Summary -->
    <section class="portfolio-summary">
      <div class="card primary">
        <div class="label">Total Portfolio Value</div>
        <div class="value">{{ portfolioStats.totalValue | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
        <div class="sub">Live balance</div>
        <div class="trend" [class.positive]="portfolioStats.todayPLPercent >= 0" 
             [class.negative]="portfolioStats.todayPLPercent < 0">
          {{ portfolioStats.todayPLPercent >= 0 ? 'â–²' : 'â–¼' }} 
          {{ portfolioStats.todayPLPercent | number:'1.1-1' }}%
        </div>
      </div>
      <div class="card">
        <div class="label">Cash Available</div>
        <div class="value">{{ portfolioStats.cashAvailable | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
        <div class="sub">Available to trade</div>
        <div class="trend neutral">â€”</div>
      </div>
      <div class="card">
        <div class="label">Invested Amount</div>
        <div class="value">{{ portfolioStats.investedAmount | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
        <div class="sub">Current holdings value</div>
        <div class="trend" [class.positive]="portfolioStats.todayPL >= 0"
             [class.negative]="portfolioStats.todayPL < 0">
          {{ portfolioStats.todayPL >= 0 ? 'â–²' : 'â–¼' }}
          {{ portfolioStats.todayPL | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}
        </div>
      </div>
      <div class="card">
        <div class="label">Total P/L</div>
        <div class="value" [class.positive]="portfolioStats.todayPL >= 0"
             [class.negative]="portfolioStats.todayPL < 0">
          {{ portfolioStats.todayPL | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}
        </div>
        <div class="sub">Unrealized gains/losses</div>
        <div class="trend" [class.positive]="portfolioStats.todayPLPercent >= 0" 
             [class.negative]="portfolioStats.todayPLPercent < 0">
          {{ portfolioStats.todayPLPercent >= 0 ? 'â–²' : 'â–¼' }} 
          {{ portfolioStats.todayPLPercent | number:'1.1-1' }}%
        </div>
      </div>
    </section>

    <section class="main-content">
      <!-- Holdings Table -->
      <div class="holdings card">
        <div class="table-header-section">
          <h3>Holdings ({{ filteredHoldings.length }})</h3>
          <div class="filters">
            <input type="text" placeholder="Search symbols..." class="search-input" [(ngModel)]="searchTerm">
            <select class="filter-select" [(ngModel)]="filterType">
              <option value="all">All Assets</option>
              <option value="crypto">Crypto</option>
            </select>
          </div>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="filteredHoldings.length === 0 && !loading" class="empty-state">
          <div class="empty-icon">ðŸ“Š</div>
          <div class="empty-text">No holdings yet</div>
          <div class="empty-subtext">Start trading to build your portfolio</div>
          <button class="btn-primary" routerLink="/markets">Explore Markets</button>
        </div>

        <!-- Holdings Table -->
        <div class="table-container" *ngIf="filteredHoldings.length > 0">
          <div class="table-header">
            <div>Symbol</div>
            <div>Name</div>
            <div>Quantity</div>
            <div>Avg Cost</div>
            <div>Current Price</div>
            <div>Market Value</div>
            <div>Total P/L</div>
            <div>P/L %</div>
            <div>Actions</div>
          </div>
          <div class="table-row" *ngFor="let holding of filteredHoldings">
            <div class="symbol-cell">
              <img *ngIf="holding.coin.image" [src]="holding.coin.image" class="coin-icon" [alt]="holding.coin.symbol">
              <span class="symbol">{{ holding.coin.symbol.toUpperCase() }}</span>
            </div>
            <div class="name-cell">{{ holding.coin.name }}</div>
            <div>{{ holding.quantity | number:'1.2-6' }}</div>
            <div>{{ holding.buyPriceConverted | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
            <div>{{ holding.currentPrice | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
            <div class="market-value">{{ holding.marketValue | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}</div>
            <div [class.positive]="holding.totalPL >= 0" [class.negative]="holding.totalPL < 0">
              {{ holding.totalPL >= 0 ? '+' : '' }}{{ holding.totalPL | number:'1.2-2' }} {{ currencyService.getCurrencySymbol() }}
            </div>
            <div [class.positive]="holding.plPercent >= 0" [class.negative]="holding.plPercent < 0">
              {{ holding.plPercent >= 0 ? '+' : '' }}{{ holding.plPercent | number:'1.2-2' }}%
            </div>
            <div class="actions">
              <button class="btn-sm" (click)="buyMore(holding)">Buy More</button>
              <button class="btn-sm sell" (click)="sell(holding)">Sell</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Asset Allocation -->
      <div class="allocation-chart card">
        <h3>Asset Allocation</h3>
        <div class="chart-container">
          <div class="pie-chart-wrapper">
            <div class="pie-center">
              <div class="total">{{ portfolioStats.investedAmount | number:'1.0-0' }} {{ currencyService.getCurrencySymbol() }}</div>
              <div class="label">Invested</div>
            </div>
          </div>
          <div class="legend">
            <div class="legend-item">
              <div class="color-box crypto"></div>
              <div class="legend-text">
                <div class="category">Crypto</div>
                <div class="percentage">{{ getAssetAllocation().crypto }}%</div>
              </div>
            </div>
            <div class="legend-item">
              <div class="color-box cash"></div>
              <div class="legend-text">
                <div class="category">Cash</div>
                <div class="percentage">
                  {{ ((portfolioStats.cashAvailable / portfolioStats.totalValue) * 100) | number:'1.0-0' }}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Performance Section -->
    <section class="performance card">
      <div class="performance-header">
        <h3>Portfolio Performance</h3>
      </div>
      <div class="performers">
        <div class="performer-card">
          <div class="performer-label">Best Performer</div>
          <div class="performer-value positive">{{ bestPerformer }}</div>
        </div>
        <div class="performer-card">
          <div class="performer-label">Worst Performer</div>
          <div class="performer-value negative">{{ worstPerformer }}</div>
        </div>
        <div class="performer-card">
          <div class="performer-label">Total Holdings</div>
          <div class="performer-value">{{ holdings.length }}</div>
        </div>
        <div class="performer-card">
          <div class="performer-label">Total Trades</div>
          <div class="performer-value">{{ orders.length }}</div>
        </div>
      </div>
    </section>
  </main>
</div>
